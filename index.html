<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Chat Supabase</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f4f4f4;
}
#chat {
    width: 420px;
    margin: 40px auto;
    background: white;
    padding: 12px;
    border-radius: 6px;
}
#messages {
    height: 300px;
    overflow-y: auto;
    border: 1px solid #ccc;
    padding: 6px;
    margin-bottom: 10px;
}
input, button {
    padding: 8px;
}
#msg {
    width: 72%;
}
</style>
</head>
<body>

<div id="chat">
    <h3>Chat public</h3>
    <div id="messages"></div>
    <input id="msg" placeholder="Message..." />
    <button onclick="send()">Envoyer</button>
</div>

<script>
/* Injection Vercel */
const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
const SUPABASE_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY;

const supabase = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_KEY
);

const pseudo = prompt("Choisis ton pseudo :") || "Anonyme";
const messagesDiv = document.getElementById("messages");

/* Charger historique */
async function loadMessages() {
    const { data } = await supabase
        .from("messages")
        .select("*")
        .order("created_at", { ascending: true });

    messagesDiv.innerHTML = "";
    data.forEach(addMessage);
}

function addMessage(msg) {
    const div = document.createElement("div");
    div.textContent = `${msg.pseudo} : ${msg.content}`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

/* Realtime */
supabase.channel("chat-room")
    .on(
        "postgres_changes",
        { event: "INSERT", schema: "public", table: "messages" },
        payload => addMessage(payload.new)
    )
    .subscribe();

/* Envoi */
async function send() {
    const input = document.getElementById("msg");
    if (!input.value.trim()) return;

    await supabase.from("messages").insert({
        pseudo,
        content: input.value
    });

    input.value = "";
}

loadMessages();
</script>

</body>
</html>